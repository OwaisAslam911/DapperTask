@model DapperTask.Models.PositionMappingViewModel

<div class="container">
    <h2>Position Mapping</h2>
    <form id="mappingForm" method="post">
        <div class="mb-3">
            <label for="OrganizationId" class="form-label">Organization</label>
            <select name="OrganizationId" id="OrganizationId" class="form-control" required>
                <option value="Select Organizations">Select Organization</option>
                @foreach (var org in Model.Organizations)
                {
                    <option value="@org.OrganizationId">@org.OrganizationName</option>
                }
            </select>
        </div>
        <div class="mb-3">
            <label for="DepartmentId" class="form-label">Department</label>
            <select name="DepartmentId" id="DepartmentId" class="form-control" required>
                <option value="Select Department">Select Department</option>
                @foreach (var dept in Model.Departments)
                {
                    <option value="@dept.DepartmentId">@dept.DepartmentName</option>
                }
            </select>
        </div>
        <div class="mb-3">
            <label for="PositionId" class="form-label">Position</label>
            <select name="PositionId" id="PositionId" class="form-control" required>
                    <option value="Select Position">Select Position</option>
                @foreach (var pos in Model.Positions)
                {
                    <option value="@pos.PositionId">@pos.PositionTitle</option>
                }
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Add Mapping</button>
    </form>

    <h2>Current Mappings</h2>
    <table class="table" id="mappingTable">
        <thead>
            <tr>
                <th>Post Map ID</th>
                <th>Organization</th>
                <th>Department</th>
                <th>Position</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
<tbody>
    @foreach (var mapping in Model.PositionMappings) // Assume Model.PositionMappings is a list of PositionMappingViewModel
    {
        <tr>
            <td>@mapping.PostMapId</td>
            <td>@mapping.OrganizationName</td>
            <td>@mapping.DepartmentName</td>
            <td>@mapping.PositionTitle</td>
            <td>
                <button class="btn btn-danger" onclick="deleteMapping(@mapping.PostMapId)">Delete</button>
            </td>
        </tr>
    }
</tbody>

        </tbody>
    </table>
</div>

@section Scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            // Load existing mappings
            loadMappings();

            $('#mappingForm').submit(function (event) {
                event.preventDefault(); // Prevent the default form submission

                var newMapping = {
                    OrganizationId: $('#OrganizationId').val(),
                    DepartmentId: $('#DepartmentId').val(),
                    PositionId: $('#PositionId').val()
                };

                $.post('@Url.Action("CreateMapping", "Home")', newMapping, function (response) {
                    if (response.success) {
                        // Append the new mapping to the table
                        var newRow = `
                            <tr>
                                <td>${response.PostMapId}</td>
                                <td>${response.OrganizationName}</td>
                                <td>${response.DepartmentName}</td>
                                <td>${response.PositionTitle}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="deleteMapping(${response.PostMapId})">Delete</button>
                                </td>
                            </tr>`;
                        $('#mappingTable tbody').append(newRow);
                        $('#mappingForm')[0].reset(); // Clear form
                    }
                });
            });
        });

        function loadMappings() {
            $.get('@Url.Action("GetMappings", "PositionMapping")', function (mappings) {
                $.each(mappings, function (index, mapping) {
                    var newRow = `
                        <tr>
                            <td>${mapping.PostMapId}</td>
                            <td>${mapping.OrganizationName}</td>
                            <td>${mapping.DepartmentName}</td>
                            <td>${mapping.PositionTitle}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteMapping(${mapping.PostMapId})">Delete</button>
                            </td>
                        </tr>`;
                    $('#mappingTable tbody').append(newRow);
                });
            });
        }

        function deleteMapping(postMapId) {
            if (confirm('Are you sure you want to delete this mapping?')) {
                $.post('@Url.Action("DeleteMapping", "PositionMapping")', { PostMapId: postMapId }, function (response) {
                    if (response.success) {
                        // Remove the row from the table
                        $('#mappingTable tbody tr').has(`td:contains(${postMapId})`).remove();
                    }
                });
            }
        }
    </script>
}
